#!/usr/bin/env node
"use strict";var c=Object.create;var H=Object.defineProperty;var _=Object.getOwnPropertyDescriptor;var O=Object.getOwnPropertyNames;var f=Object.getPrototypeOf,E=Object.prototype.hasOwnProperty;var v=(e,o,n,d)=>{if(o&&typeof o=="object"||typeof o=="function")for(let a of O(o))!E.call(e,a)&&a!==n&&H(e,a,{get:()=>o[a],enumerable:!(d=_(o,a))||d.enumerable});return e};var g=(e,o,n)=>(n=e!=null?c(f(e)):{},v(o||!e||!e.__esModule?H(n,"default",{value:e,enumerable:!0}):n,e));var h=g(require("http"));var u=require("dotenv"),R=require("dotenv-expand"),t=(0,R.expand)((0,u.config)()).parsed,s={php:{version:t?.BROWSER_PHP_VERSION!=null?t?.BROWSER_PHP_VERSION:"8.2"},composer:{version:t?.BROWSER_PHP_COMPOSER_VERSION??"2.7.1",path:t?.BROWSER_PHP_COMPOSER_PATH??"vendor/bin",name:t?.BROWSER_PHP_COMPOSER_NAME??"composer"},server:{host:t?.BROWSER_PHP_HOST??"http://localhost",port:t?.BROWSER_PHP_PORT??"2222",path:t?.BROWSER_PHP_PATH??"public",debug:t?.BROWSER_PHP_DEBUG!=null&&t?.BROWSER_PHP_DEBUG!="false"}};var m=require("@php-wasm/node"),i,p,B=h.default.createServer(async(e,o)=>{if(!i)p||(p=!0,i=await m.NodePHP.load(s.php.version,{requestHandler:{documentRoot:s.server.path,absoluteUrl:`${s.server.host}:${s.server.port}`}}),i.useHostFilesystem(),p=!1,o.statusCode=302,o.setHeader("location",e.url??""),o.end());else if(e.url){let n={};if(e.rawHeaders&&e.rawHeaders.length)for(let r=0;r<e.rawHeaders.length;r+=2)n[e.rawHeaders[r]]=e.rawHeaders[r+1];let d=new Promise(r=>{let l=[];e.on("data",S=>l.push(S)).on("end",()=>r(Buffer.concat(l).toString()))}),a={method:e.method,url:e.url,headers:n,body:await d},P=await i.request(a);s.server.debug&&console.log(a,P),delete P.headers["x-frame-options"],Object.keys(P.headers).forEach(r=>{o.setHeader(r,P.headers[r])}),o.statusCode=P.httpStatusCode,o.end(P.bytes)}});B.listen(s.server.port,async()=>console.log(`
PHP server is listening on ${s.server.host}:${s.server.port}
`));
