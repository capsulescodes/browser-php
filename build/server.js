#!/usr/bin/env node
"use strict";var f=Object.create;var u=Object.defineProperty;var g=Object.getOwnPropertyDescriptor;var S=Object.getOwnPropertyNames;var _=Object.getPrototypeOf,b=Object.prototype.hasOwnProperty;var E=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let n of S(t))!b.call(e,n)&&n!==r&&u(e,n,{get:()=>t[n],enumerable:!(i=g(t,n))||i.enumerable});return e};var O=(e,t,r)=>(r=e!=null?f(_(e)):{},E(t||!e||!e.__esModule?u(r,"default",{value:e,enumerable:!0}):r,e));var c=O(require("http"));var H=require("dotenv"),h=require("dotenv-expand"),a=(0,h.expand)((0,H.config)()).parsed,w="8.2",B="http://localhost",y="2222",T="public",V="false",s={php:a?.BROWSER_PHP_VERSION!=null?a?.BROWSER_PHP_VERSION:w,host:a?.BROWSER_PHP_HOST??B,port:a?.BROWSER_PHP_PORT??y,path:a?.BROWSER_PHP_PATH??T,debug:a?.BROWSER_PHP_DEBUG!=null&&a?.BROWSER_PHP_DEBUG!=V};var m=require("@php-wasm/node"),p,P,W=c.default.createServer(async(e,t)=>{if(!p)P||(P=!0,p=await m.NodePHP.load(s.php,{requestHandler:{documentRoot:s.path,absoluteUrl:`${s.host}:${s.port}`}}),p.useHostFilesystem(),P=!1,t.statusCode=302,t.setHeader("location",e.url??""),t.end());else if(e.url){let r={};if(e.rawHeaders&&e.rawHeaders.length)for(let o=0;o<e.rawHeaders.length;o+=2)r[e.rawHeaders[o]]=e.rawHeaders[o+1];let i=new Promise(o=>{let l=[];e.on("data",R=>l.push(R)).on("end",()=>o(Buffer.concat(l).toString()))}),n={method:e.method,url:e.url,headers:r,body:await i},d=await p.request(n);s.debug&&console.log(n,d),delete d.headers["x-frame-options"],Object.keys(d.headers).forEach(o=>{t.setHeader(o,d.headers[o])}),t.statusCode=d.httpStatusCode,t.end(d.bytes)}});W.listen(s.port,async()=>console.log(`
PHP server is listening on ${s.host}:${s.port}
`));
